name: æ›´æ–°å¹´åº¦è¿›åº¦æ¡
on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 = åŒ—äº¬æ—¶é—´ 00:00
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: è®¡ç®—å¹¶æ›´æ–°å¹´åº¦è¿›åº¦
        run: |
          cat > calculate_progress.py << 'EOF'
          import datetime
          import re
          import pytz

          # æ ¸å¿ƒä¿®æ”¹ï¼šå¼ºåˆ¶ä½¿ç”¨åŒ—äº¬æ—¶é—´è·å–å½“å‰æ—¥æœŸ
          tz_beijing = pytz.timezone('Asia/Shanghai')
          today = datetime.datetime.now(tz_beijing).date()
          
          year = today.year
          total_days = 366 if (year % 4 == 0 and year % 100 != 0) or (year % 400 == 0) else 365
          days_passed = (today - datetime.date(year, 1, 1)).days + 1
          progress_percent = round((days_passed / total_days) * 100, 2)
          date_str = today.strftime("%d-%b-%Y")

          print(f"åŒ—äº¬æ—¶é—´æ—¥æœŸï¼š{today}")
          print(f"è®¡ç®—çš„è¿›åº¦ï¼š{progress_percent}%")

          with open("README.md", "r", encoding="utf-8") as f:
              content = f.read()

          has_progress_wrap = '<!--PROGRESS_START-->' in content and '<!--PROGRESS_END-->' in content
          has_date_wrap = '<!--DATE_START-->' in content and '<!--DATE_END-->' in content

          if not has_progress_wrap or not has_date_wrap:
              content = re.sub(
                  r'<!--YEAR_PROGRESS_PERCENT-->',
                  f'<!--PROGRESS_START-->{progress_percent}%<!--PROGRESS_END-->',
                  content
              )
              content = re.sub(
                  r'<!--YEAR_PROGRESS_DATE-->',
                  f'<!--DATE_START-->{date_str}<!--DATE_END-->',
                  content
              )
              print("åˆå§‹åŒ–åŒ…è£¹å¼æ ‡è®°å®Œæˆ")
          else:
              content = re.sub(
                  r'<!--PROGRESS_START-->.*?<!--PROGRESS_END-->',
                  f'<!--PROGRESS_START-->{progress_percent}%<!--PROGRESS_END-->',
                  content
              )
              content = re.sub(
                  r'<!--DATE_START-->.*?<!--DATE_END-->',
                  f'<!--DATE_START-->{date_str}<!--DATE_END-->',
                  content
              )
              print("æ›´æ–°åŒ…è£¹å¼æ ‡è®°å†…çš„æ•°å€¼å®Œæˆ")

          with open("README.md", "w", encoding="utf-8") as f:
              f.write(content)
          EOF
          
          # å®‰è£… pytz ä¾èµ–ï¼ˆå¿…é¡»ï¼‰
          pip install pytz
          python calculate_progress.py

      - name: é…ç½®Gitå¹¶æ¨é€
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git add README.md
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹´åº¦è¿›åº¦æ¡: $(TZ='Asia/Shanghai' date +'%Y-%m-%d')" || echo "æ— ä¿®æ”¹æ— éœ€æäº¤"
          git push origin main -f
