name: æ›´æ–°å¹´åº¦è¿›åº¦æ¡
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # æ˜¾å¼å£°æ˜å†™å…¥ä»£ç çš„æƒé™ï¼ˆå…³é”®ï¼ï¼‰
  pull-requests: write

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # ç¦ç”¨é»˜è®¤å‡­è¯ï¼Œé¿å…å†²çª

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: è®¡ç®—å¹¶æ›´æ–°å¹´åº¦è¿›åº¦
        run: |
          cat > calculate_progress.py << 'EOF'
          import datetime
          import re

          today = datetime.date.today()
          year = today.year
          total_days = 366 if (year % 4 == 0 and year % 100 != 0) or (year % 400 == 0) else 365
          days_passed = (today - datetime.date(year, 1, 1)).days + 1
          progress_percent = round((days_passed / total_days) * 100, 2)
          date_str = today.strftime("%d-%b-%Y")

          with open("README.md", "r", encoding="utf-8") as f:
              content = f.read()

          content = re.sub(r'<!--YEAR_PROGRESS_PERCENT-->', f'{progress_percent}%', content)
          content = re.sub(r'<!--YEAR_PROGRESS_DATE-->', date_str, content)

          with open("README.md", "w", encoding="utf-8") as f:
              f.write(content)
          EOF

          python calculate_progress.py

      - name: é…ç½®Gitå¹¶æ¨é€ï¼ˆç»ˆææˆæƒç‰ˆï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ ¸å¿ƒä¿®å¤ï¼šç”¨GITHUB_TOKENæ„å»ºå¸¦æƒé™çš„æ¨é€åœ°å€
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

          git add README.md
          # ä»…å½“æ–‡ä»¶æœ‰ä¿®æ”¹æ—¶æäº¤
          if ! git diff --quiet && ! git diff --staged --quiet; then
              git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹´åº¦è¿›åº¦æ¡: $(date +'%Y-%m-%d')"
              git push origin main  # æ˜¾å¼æŒ‡å®šæ¨é€åˆ°mainåˆ†æ”¯
          fi