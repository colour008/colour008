name: æ›´æ–°å¹´åº¦è¿›åº¦æ¡
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC0ç‚¹è¿è¡Œ
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # æ˜¾å¼æˆæƒå†™å…¥
  pull-requests: write

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…åˆ†æ”¯é—®é¢˜

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: æ‰“å°å½“å‰ç›®å½•å’Œæ–‡ä»¶ï¼ˆæ’æŸ¥è·¯å¾„ï¼‰
        run: |
          pwd
          ls -la  # ç¡®è®¤README.mdå­˜åœ¨
          cat README.md | grep "å¹´åº¦è¿›åº¦æ¡"  # ç¡®è®¤æ ‡è®°å­˜åœ¨

      - name: è®¡ç®—å¹¶æ›´æ–°å¹´åº¦è¿›åº¦
        run: |
          # å†™å…¥è„šæœ¬ï¼ˆå¢åŠ æ—¥å¿—ï¼‰
          cat > calculate_progress.py << 'EOF'
          import datetime
          import re

          today = datetime.date.today()
          year = today.year
          total_days = 366 if (year % 4 == 0 and year % 100 != 0) or (year % 400 == 0) else 365
          days_passed = (today - datetime.date(year, 1, 1)).days + 1
          progress_percent = round((days_passed / total_days) * 100, 2)
          date_str = today.strftime("%d-%b-%Y")

          # æ‰“å°è®¡ç®—ç»“æœï¼ˆæ–¹ä¾¿æ’æŸ¥ï¼‰
          print(f"è®¡ç®—çš„è¿›åº¦ï¼š{progress_percent}%")
          print(f"è®¡ç®—çš„æ—¥æœŸï¼š{date_str}")

          # è¯»å–READMEï¼ˆæŒ‡å®šç¼–ç ï¼Œé¿å…ä¹±ç ï¼‰
          with open("README.md", "r", encoding="utf-8") as f:
              content = f.read()

          # æ£€æŸ¥æ ‡è®°æ˜¯å¦å­˜åœ¨
          if '<!--YEAR_PROGRESS_PERCENT-->' not in content:
              print("é”™è¯¯ï¼šæ²¡æ‰¾åˆ° <!--YEAR_PROGRESS_PERCENT--> æ ‡è®°ï¼")
              exit(1)
          if '<!--YEAR_PROGRESS_DATE-->' not in content:
              print("é”™è¯¯ï¼šæ²¡æ‰¾åˆ° <!--YEAR_PROGRESS_DATE--> æ ‡è®°ï¼")
              exit(1)

          # æ‰§è¡Œæ›¿æ¢
          content = re.sub(r'<!--YEAR_PROGRESS_PERCENT-->', f'{progress_percent}%', content)
          content = re.sub(r'<!--YEAR_PROGRESS_DATE-->', date_str, content)

          # å†™å…¥æ–‡ä»¶
          with open("README.md", "w", encoding="utf-8") as f:
              f.write(content)

          # éªŒè¯æ›¿æ¢ç»“æœ
          with open("README.md", "r", encoding="utf-8") as f:
              new_content = f.read()
          print("æ›¿æ¢åçš„è¿›åº¦æ¡è¡Œï¼š")
          for line in new_content.split("\n"):
              if "å¹´åº¦è¿›åº¦æ¡" in line:
                  print(line)
          EOF

          # æ‰§è¡Œè„šæœ¬å¹¶æ‰“å°æ—¥å¿—
          python calculate_progress.py

      - name: é…ç½®Gitå¹¶æ¨é€
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

          # æ‰“å°GitçŠ¶æ€ï¼ˆæ’æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹ï¼‰
          git status

          git add README.md
          # æäº¤å¹¶æ¨é€ï¼ˆå¼ºåˆ¶æäº¤ï¼Œé¿å…ç©ºåˆ¤æ–­é—®é¢˜ï¼‰
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹´åº¦è¿›åº¦æ¡: $(date +'%Y-%m-%d')" || echo "æ— ä¿®æ”¹æ— éœ€æäº¤"
          git push origin main -f  # å¼ºåˆ¶æ¨é€ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼Œåç»­å¯å»æ‰-fï¼‰